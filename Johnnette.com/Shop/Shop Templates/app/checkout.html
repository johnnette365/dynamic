{% extends 'app/base.html' %} {% load static %} {% block title %}Buy Now{% endblock title %} {% block page_css %}
<style>
    .detail {
        padding-left: 10px;
        box-sizing: border-box;
        overflow: hidden;
    }
    
    .detail>div {
        margin-top: 5px;
    }
    
    .company_logo img {
        display: flex;
        width: 100%;
    }
    
    .brand_name {
        font-weight: bold;
    }
</style>
{% endblock page_css %} {% block content %}
<span style="position: static; display: inline-block; height: 100px;" class="balance"></span> 
<div class="container">
    <div class="row mt-5">
        <div class="col-sm-6 mb-3">
            <div style="background-color: white; padding: 15px 15px 15px 15px; border-radius: 5px;">
                <h4>Order Summary</h4>
                <hr> {% for items in cart_items %}
                <div class="card mb-2 pt-3 pb-3 pl-4" style="padding-left: 20px;">
                    <h5>Product: {{ forloop.counter }}</h5>
                    <div class="detail">
                        <div class="brand_name">{{ items.product.brand_name }}</div>
                        <div class="product_title">{{ items.product.product_title }}</div>
                        <div class="product_price">
                            <p>Quantity: &nbsp; {{ items.quantity}} </p>
                            <span class="selling_price"><strong>Price: &nbsp;<span>&#8377;</span>{{ items.total_cost }}</strong>
                            </span> &nbsp;
                        </div>
                    </div>
                </div>
                <p>Total Cost + Rs. 70 = {{ totalamount }} </p>
                {% endfor %}
            </div>
            <br>
            <small style="color: white;"><strong style="color: gray;">Term and Condition:</strong> &nbsp; Lorem ipsum dolor sit amet consectetur adipisicing elit. Mollitia, ullam saepe! Iure optio repellat dolor velit, minus rem. Facilis cumque neque numquam laboriosam, accusantium adipisci nisi nihil in et quis?</small>
        </div>
        <div class="col-sm-4 offset-sm-1">
            <div style="background-color: white; padding: 15px 15px 15px 15px; border-radius: 5px;">
                <h4>Your Shipping Address</h4>
                <hr>
                <form id="payment-form">
                    <!-- address -->
                    {% for add in add %}
                    <div class="card">
                        <div class="card-body">
                            <h5>{{ add.full_name }}</h5>
                            <p>{{ add.locality }}, {{ add.city }}, {{ add.state }} - {{ add.pincode }}</p>
                        </div>
                    </div>
                    <div class="form-check mt-2 mb-2">
                        <input style="visibility:hidden;" class="form-check-input" type="radio" name="custid" id="custadd{{forloop.counter}}" value="{{add.id}}"  checked>
                    </div>
                    {% endfor %}
                    <div class="text-end">
                        <button id="rzp-button1" type="submit" class="btn btn-warning mt-3 px-5 fw-bold">Countinue</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<br><br>


<!-- <h1>paytm merchant payment page</h1>
<form action="https://securegw-stage.paytm.in/theia/processTransaction" method="post" name="paytm">
    {% for key, value in param_dict.items %}
    <input type="hidden" name="{{key}}" value="{{value}}"> {% endfor %}
</form>

<script>
    document.paytm.submit()
</script> -->






{% endblock content %} 


{% block page_js %} 
    {% comment %} <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
        var options = {
            "key": "rzp_test_qg6vjrkp4rXSOI", // Enter the Key ID generated from the Dashboard
            "amount": "{{payment.amount}}", // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
            "currency": "INR",
            "name": "Johnnette Technologies",
            "description": "Test Transaction",
            "image": "https://example.com/your_logo",
            "order_id": "{{payment.id}}", //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
            "callback_url":"{{callback_url}}",
            "handler": function (response){
            },
            "prefill": {
                "name": "Gaurav Kumar",
                "email": "gaurav.kumar@example.com",
                "contact": "9000090000"
            },
            "notes": {
                "address": "Razorpay Corporate Office"
            },
            "theme": {
                "color": "#3399cc"
            }
        };
        var rzp1 = new Razorpay(options);
        rzp1.on('payment.failed', function (response){
                alert(response.error.code);
                alert(response.error.description);
                alert(response.error.source);
                alert(response.error.step);
                alert(response.error.reason);
                alert(response.error.metadata.order_id);
                alert(response.error.metadata.payment_id);
        });
        document.getElementById('rzp-button1').onclick = function(e){
            rzp1.open();
            e.preventDefault();
        }
    </script>  {% endcomment %}






    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
        var options = {
            "key": "rzp_test_qg6vjrkp4rXSOI", // Enter the Key ID generated from the Dashboard
            "amount": "{{payment.amount}}", // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
            "currency": "INR",
            "name": "Johnnette Technologies",
            "description": "Test Transaction",
            "order_id": "{{payment.id}}", //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
            "callback_url": "{{callback_url}}",
            "prefill": {
                "name": "Gaurav Kumar",
                "email": "gaurav.kumar@example.com",
                "contact": "9000090000"
            },
            "theme": {
            "color": "#2BA977"
            },
        };
        var rzp1 = new Razorpay(options);
        document.getElementById('rzp-button1').onclick = function (e) {
            rzp1.open();
            e.preventDefault();
        }
        
    </script>
{% endblock page_js %}















{% comment %} To send a failed response from Razorpay to a specific URL, you can use the Razorpay Webhooks feature. Webhooks allow you to receive notifications about events that occur in your Razorpay account and send them to an endpoint URL of your choice.

Here are the steps you can follow:

Set up a webhook endpoint on your server that can receive POST requests.
Log in to your Razorpay account and go to the Webhooks section.
Click on the "Add Webhook" button and provide the necessary details, including the URL of your endpoint.
Under the "Event" section, select the event for which you want to receive notifications. In this case, you can select the "Payment Failed" event.
Save the webhook and ensure that it is enabled.
When a payment fails in Razorpay, a POST request containing the details of the failed payment will be sent to the URL you specified in the webhook. You can then process the response as required.

Note that to set up webhooks, you should have some programming knowledge and experience working with APIs. If you're not comfortable with this, you may want to consider getting help from a developer or using a payment gateway that offers simpler integration options. {% endcomment %}











{% comment %} import hmac
import hashlib
import json
from flask import Flask, request, jsonify

app = Flask(__name__)

@app.route('/webhook', methods=['POST'])
def handle_webhook():
    # Retrieve the request body as a string
    request_body = request.data.decode('utf-8')

    # Verify the webhook signature (optional but recommended)
    webhook_secret = 'your_webhook_secret_key' # Replace with your actual webhook secret key
    signature = request.headers.get('X-Razorpay-Signature')
    verified = verify_webhook_signature(request_body, signature, webhook_secret)

    if not verified:
        return jsonify({'status': 'error', 'message': 'Webhook signature verification failed'}), 400

    # Parse the request body as JSON
    payload = json.loads(request_body)

    # Check if the event is a payment failed event
    if payload['event'] == 'payment.failed':
        # Handle the payment failed event
        payment_id = payload['payload']['payment']['entity']['id']
        amount = payload['payload']['payment']['entity']['amount']
        currency = payload['payload']['payment']['entity']['currency']

        # Do something with the payment details, like update your database or send an email notification
        # ...

        # Send a response back to Razorpay to confirm receipt of the webhook
        return jsonify({'status': 'success'}), 200

def verify_webhook_signature(request_body, signature, webhook_secret):
    expected_signature = hmac.new(webhook_secret.encode('utf-8'), request_body.encode('utf-8'), hashlib.sha256).hexdigest()
    return hmac.compare_digest(signature, expected_signature)

if __name__ == '__main__':
    app.run() {% endcomment %}


{% comment %} This code does the following:

Defines a Flask route to handle POST requests to the /webhook endpoint.
Retrieves the request body as a string.
Verifies the webhook signature (optional but recommended).
Parses the request body as JSON.
Checks if the event is a payment failed event.
Processes the payment details (in this example, it just prints them to the screen).
Sends a response back to Razorpay to confirm receipt of the webhook.
Note that this is just an example and you may need to modify it based on your specific requirements. Also, the verify_webhook_signature function should be implemented using the actual method that Razorpay provides for verifying webhook signatures. {% endcomment %}